<?php
// tickets_stats.php
require_once '../dbconnection.php';

// 1. Tickets por prioridad (Pastel)
$stmt = $pdo->query("SELECT prioridad, COUNT(*) as total 
    FROM ticket
    GROUP BY prioridad");
$prioridades = $stmt->fetchAll(PDO::FETCH_ASSOC);

// 2. Problema más recurrente
$stmt = $pdo->query("SELECT description, COUNT(*) as total 
    FROM ticket 
    GROUP BY description 
    ORDER BY total DESC LIMIT 5");
$problemas = $stmt->fetchAll(PDO::FETCH_ASSOC);

// 3. Conteo diario de tickets del mes actual
$stmt = $pdo->query("
    SELECT DAY(posting_date) as dia, COUNT(*) as total
    FROM ticket
    WHERE MONTH(posting_date) = MONTH(CURRENT_DATE()) 
    AND YEAR(posting_date) = YEAR(CURRENT_DATE())
    GROUP BY dia
");
$conteo_diario = $stmt->fetchAll(PDO::FETCH_ASSOC);

// 4. Áreas que más tickets generan
$stmt = $pdo->query("
    SELECT area, COUNT(*) as total
    FROM ticket
    GROUP BY area
    ORDER BY total DESC
");
$areas = $stmt->fetchAll(PDO::FETCH_ASSOC);

// Respuesta JSON
header('Content-Type: application/json');
echo json_encode([
    "prioridades" => $prioridades,
    "problemas" => $problemas,
    "conteo_diario" => $conteo_diario,
    "areas" => $areas
]);
